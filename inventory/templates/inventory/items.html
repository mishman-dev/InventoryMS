{% extends 'inventory/base.html' %}

{% block title %}Items | Inventory Management{% endblock %}
{% block content %}
<div class="mx-auto py-2 px-4 sm:px-6 lg:px-2">
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 animate-slideDown flex justify-between">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Item List</h1>
        <div class="flex space-x-3">
            <!-- ðŸ”½ Filter Dropdown -->
            <form method="get" class="flex items-center space-x-2">
            <select name="filter" onchange="this.form.submit()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All Items</option>
                <option value="low_stock" {% if filter_type == 'low_stock' %}selected{% endif %}>Low Stock</option>
                <option value="out_of_stock" {% if filter_type == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
                <option value="expired_warranty" {% if filter_type == 'expired_warranty' %}selected{% endif %}>Expired Warranty</option>
            </select>
            </form>

            <!-- ðŸ” Search -->
            <form method="get" class="flex items-center space-x-2">
            <input type="text" name="search" placeholder="Search items..." value="{{ search_query }}" 
                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
            <button type="submit" class="hidden">Search</button>
            </form>

            <!-- âž• Add Product -->
            <button id="addItemBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-sm text-sm font-medium flex items-center">
            <span class="material-icons-outlined text-white text-sm mr-1">add</span>
            Add Item
            </button>
        </div>
        </div>

    </div>
    

    <div class="overflow-hidden rounded-lg shadow">
      <table class="min-w-full divide-y divide-gray-200 bg-white">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Item Code</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Name</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Category</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Unit Price</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Current Stock</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Reorder Level</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Warranty</th>
          </tr>
        </thead>

        <tbody id="itemTable" class="divide-y divide-gray-100">
          {% for item in items %}
        <tr class="{% if item.current_stock == 0 %} bg-red-100 {% elif item.current_stock <= item.reorder_level %} bg-yellow-50 {% endif %}">
            <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ item.item_code }}</td>
            <td class="px-6 py-4 text-sm text-gray-800">{{ item.name }}</td>
            <td class="px-6 py-4 text-sm text-gray-600">{{ item.category.category_name|default:"â€”" }}</td>
            <td class="px-6 py-4 text-sm text-gray-700">à¶»à·”. {{ item.unit_price|floatformat:2 }}</td>
            <td class="px-6 py-4 text-sm">
              {% if item.current_stock <= item.reorder_level %}
                <span class="text-red-600 font-semibold">{{ item.current_stock }}</span>
              {% else %}
                <span class="text-green-600 font-semibold">{{ item.current_stock }}</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-sm text-gray-700">{{ item.reorder_level }}</td>
            <td class="px-6 py-4 text-sm text-gray-600">
              {% if item.warrenty %}
                {{ item.warrenty|date:"Y-m-d" }}
              {% else %}
                <span class="text-gray-400">N/A</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="px-6 py-6 text-center text-gray-500">No items found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div id="addModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-lg">
      <h2 class="text-2xl font-semibold mb-4">Add New Item</h2>
      <form id="addItemForm" class="space-y-4">
        {% csrf_token %}
        <div>
          <label class="block text-gray-700 mb-1">Name</label>
          <input name="name" type="text" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-gray-700 mb-1">Category</label>
          <select name="category_name" class="w-full border rounded-lg px-4 py-2">
            <option value="">â€” None â€”</option>
            {% for cat in categories %}
              <option value="{{ cat.category_id }}">{{ cat.category_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 mb-1">Unit</label>
            <input name="default_unit_of_measure" type="text" required class="w-full border rounded-lg px-4 py-2">
          </div>
          <div>
            <label class="block text-gray-700 mb-1">Unit Price</label>
            <input name="unit_price" type="number" step="0.01" required class="w-full border rounded-lg px-4 py-2">
          </div>
          <div>
            <label class="block text-gray-700 mb-1">Reorder Level</label>
            <input name="reorder_level" type="number" required class="w-full border rounded-lg px-4 py-2">
          </div>
        </div>

        <div>
          <label class="block text-gray-700 mb-1">Current Stock</label>
          <input name="current_stock" type="number" min="0" required class="w-full border rounded-lg px-4 py-2">
        </div>
        <div>
          <label class="block text-gray-700 mb-1">Supplier</label>
          <select name="supplier_id" class="w-full border rounded-lg px-4 py-2">
            <option value="">â€” None â€”</option>
            {% for supplier in suppliers %}
              <option value="{{ supplier.supplier_id }}">{{ supplier.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-gray-700 mb-1">Warrenty (if applicable)</label>
          <input name="warrenty" type="date"class="w-full border rounded-lg px-4 py-2">
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" id="closeModal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">Add Item</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const modal = document.getElementById('addModal');
    const addBtn = document.getElementById('addItemBtn');
    const closeBtn = document.getElementById('closeModal');
    const form = document.getElementById('addItemForm');
    const table = document.getElementById('itemTable');

    // Open and close modal
    addBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden'); // prevent background scroll
    });

    function closeModal() {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    closeBtn.addEventListener('click', closeModal);

    // Handle form submit
    form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
        const res = await fetch("{% url 'add_item' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });

        const data = await res.json();

        if (res.ok && data.success) {
            const item = data.item;

            const newRow = document.createElement('tr');
            newRow.className = 'hover:bg-gray-50 transition';
            newRow.innerHTML = `
            <td class="px-6 py-4 text-sm font-medium">${item.item_code}</td>
            <td class="px-6 py-4 text-sm">${item.name}</td>
            <td class="px-6 py-4 text-sm">${item.category_name || '-'}</td>
            <td class="px-6 py-4 text-sm">Rs. ${item.unit_price}</td>
            <td class="px-6 py-4 text-sm">${item.current_stock}</td>
            <td class="px-6 py-4 text-sm">${item.reorder_level}</td>
            <td class="px-6 py-4 text-sm">${item.warrenty}</td>
            `;
            table.appendChild(newRow);

            form.reset();
            closeModal();

            showToast('âœ… Item added successfully!');
        } else {
            // show meaningful error from server
            const msg = data && data.error ? data.error : 'Failed to add item. Please try again.';
            console.error('Add item error:', data);
            alert('âŒ ' + msg);
        }
    } catch (err) {
        console.error(err);
        alert('âš ï¸ Network or server error occurred while adding the item.');
    }
});

function showToast(text) {
    const toast = document.createElement('div');
    toast.textContent = text;
    toast.className = 'fixed bottom-6 right-6 bg-blue-500 text-white px-5 py-3 rounded-xl shadow-2xl text-sm font-medium';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

    // Optional: Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
        closeModal();
        }
    });

    
        const searchInput = document.getElementById('searchInput');
        const tableRows = document.querySelectorAll('#itemTable tr');

        searchInput.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        tableRows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
        });
  </script>

{% endblock %}
