{% extends 'inventory/base.html' %}

{% block title %}Add Purchases | Inventory Management{% endblock %}
{% block content %}
{% load static %}

<div class="p-6">
  <div class="flex justify-between mb-4">
    <h1 class="text-2xl font-semibold">Add Purchase</h1>
    <a href="{% url 'purchase_list' %}" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Back</a>
  </div>

  <form method="POST" class="bg-white rounded-xl shadow-lg p-6">
    {% csrf_token %}

    <!-- Supplier -->
    <div class="mb-4">
      <label class="block text-gray-700 mb-2">Supplier</label>
      <select name="supplier" class="w-full border px-3 py-2 rounded-lg focus:ring focus:ring-blue-200" required>
        <option value="" disabled selected>Select Supplier</option>
        {% for supplier in suppliers %}
          <option value="{{ supplier.id }}">{{ supplier.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Dynamic Item Rows -->
    <div id="itemRows">
      <div class="grid grid-cols-4 gap-4 mb-2 item-row">
        <div>
          <label class="block text-gray-600 text-sm mb-1">Item</label>
          <select name="item[]" class="w-full border px-2 py-1 rounded-lg item-select">
            <option value="" disabled selected>Select Item</option>
            {% for item in items %}
              <option value="{{ item.id }}">{{ item.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-gray-600 text-sm mb-1">Quantity</label>
          <input type="number" name="quantity[]" min="1" value="1" class="w-full border px-2 py-1 rounded-lg quantity-input">
        </div>
        <div>
          <label class="block text-gray-600 text-sm mb-1">Unit Price</label>
          <input type="number" step="0.01" name="unit_price[]" readonly class="w-full border px-2 py-1 rounded-lg unit-price-input bg-gray-100">
        </div>
        <div class="flex items-end">
          <button type="button" onclick="removeRow(this)" class="bg-red-500 text-white px-3 py-1 rounded-lg">Remove</button>
        </div>
      </div>
    </div>

    <button type="button" id="addRow" class="mt-3 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">+ Add Item</button>

    <div class="flex justify-end mt-6">
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Save Purchase</button>
    </div>
  </form>
</div>

<script>
// clone a new item row
document.getElementById('addRow').addEventListener('click', () => {
  const row = document.querySelector('.item-row').cloneNode(true);
  row.querySelectorAll('input').forEach(input => input.value = '');
  document.getElementById('itemRows').appendChild(row);
});

// remove a row
function removeRow(btn) {
  const rows = document.querySelectorAll('.item-row');
  if (rows.length > 1) {
    btn.closest('.item-row').remove();
  }
}

// fetch unit price from backend
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('item-select')) {
    const itemId = e.target.value;
    const unitPriceInput = e.target.closest('.item-row').querySelector('.unit-price-input');
    fetch(`/get-item-price/?item_id=${itemId}`)
      .then(res => res.json())
      .then(data => {
        unitPriceInput.value = data.unit_price;
      });
  }
});
</script>
{% endblock %}